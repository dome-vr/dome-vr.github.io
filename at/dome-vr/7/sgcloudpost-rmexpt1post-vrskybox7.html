<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    
    <!-- Dynamic base tag will be inserted here by JavaScript if needed -->
    
    <title>
      sgcloudpost-rmexpt1post-vrskybox7:three0.125.02-webGL2-es300:dynamic-paths
      scene ='./app/scenes/@T/post/7/sgcloudpost-rmexpt1post-vrskybox7.js',
    </title>
    
    <style>
      body { margin: 0;
             padding: 0;
             font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 
               'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 
               'Droid Sans', 'Helvetica Neue', sans-serif;
               -webkit-font-smoothing: antialiased;
               -moz-osx-font-smoothing: grayscale;
      }
      #canvas-container{ position: relative; width: 100vw; height: 100vh;}
      #startAudio {
        position: absolute;
        z-index:10;
        top: 90.5%;          
        left: 1%;      
        padding: 8px 16px;   
        margin: 0;
        border-radius: 4px;    
        box-sizing: border-box;
        text-decoration: none;
        font-family:'Roboto',sans-serif;
        font-weight: 400;      
        color: #FFFFFF;       
        background-color: #1a1a1a; 
        border: 2px solid #bbb;   
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;       
      }  
     
      code {
        font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
          monospace;
      }
      
      /* Debug info panel */
      #debug-info {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: #0f0;
        font-family: monospace;
        font-size: 12px;
        padding: 10px;
        border-radius: 5px;
        max-width: 400px;
        z-index: 1000;
        display: none; /* Set to 'block' to show debug info */
      }
    </style>
  </head>

  <body>
    <!-- NOTE:canvas is styled exactly as Singularity.css -->
    <div id='canvas-container'>
      <canvas id='webgl' style='width:100vw; height:100vh; background-color:black; position:absolute; left:0px; top:0px;'/>
    </div>
    
    <!-- Debug info panel (hidden by default, set display:block to show) -->
    <div id="debug-info"></div>

    <!-- Environment detection and base tag setup -->
    <script>
      // Detect environment and set up paths accordingly
      (function() {
        const hostname = window.location.hostname;
        const pathname = window.location.pathname;
        const protocol = window.location.protocol;
        
        // Detect if running on GitHub Pages, localhost, or file://
        const isGitHubPages = hostname.includes('github.io');
        const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
        const isFileProtocol = protocol === 'file:';
        
        // Detect if we're in a subdirectory on GitHub Pages
        // For username.github.io, pathname starts with /
        // For username.github.io/project, pathname starts with /project/
        const pathParts = pathname.split('/').filter(p => p);
        const isInSubdir = isGitHubPages && pathParts.length > 1;
        
        // Store environment info globally for use in modules
        window.ENV_INFO = {
          isGitHubPages,
          isLocalhost,
          isFileProtocol,
          isInSubdir,
          hostname,
          pathname,
          protocol
        };
        
        // Set base tag only for localhost with live-server
        if (isLocalhost && !isGitHubPages) {
          const base = document.createElement('base');
          base.href = '/dist/';
          document.head.appendChild(base);
          window.ENV_INFO.basePath = '/dist/';
        } else {
          window.ENV_INFO.basePath = '';
        }
        
        // Debug output (uncomment to see environment detection)
        const debugInfo = `
Environment Detection:
- Hostname: ${hostname}
- Pathname: ${pathname}
- Protocol: ${protocol}
- Is GitHub Pages: ${isGitHubPages}
- Is Localhost: ${isLocalhost}
- Is File Protocol: ${isFileProtocol}
- Is in Subdirectory: ${isInSubdir}
- Base Path: ${window.ENV_INFO.basePath || '(none)'}
        `;
        
        // Show debug info if element exists
        const debugElement = document.getElementById('debug-info');
        if (debugElement && debugElement.style.display === 'block') {
          debugElement.textContent = debugInfo;
        }
        
        console.log(debugInfo);
      })();
    </script>

    <!-- ES Module Shims for import maps -->
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    
    <!-- Dynamic import map -->
    <script type="importmap-shim">
      {
        "imports": {
          "three": "./node_modules/three/build/three.module.js",
          "three/addons/": "./node_modules/three/examples/jsm/"
        }
      }
    </script>

    <script type="module-shim"> 
      // Get environment-specific path prefix
      const env = window.ENV_INFO;
      
      // Build paths based on environment
      let pathPrefix = '';
      let threePathPrefix = '';
      
      if (env.isLocalhost && !env.isGitHubPages) {
        // Local development with live-server - base tag handles it
        pathPrefix = './';
        threePathPrefix = '../../';
      } else if (env.isGitHubPages) {
        // GitHub Pages - use relative paths from HTML location
        pathPrefix = './dist/';
        threePathPrefix = './';
      } else if (env.isFileProtocol) {
        // File protocol - use relative paths
        pathPrefix = './dist/';
        threePathPrefix = './';
      } else {
        // Default fallback
        pathPrefix = './dist/';
        threePathPrefix = './';
      }
      
      // SCENE and BOOTSTRAP-CONTROLLER modules - variable by url
      // NOTE: Fix the path - should be @T not T
      const _scene = pathPrefix + 'app/scenes/@T/post/7/sgcloudpost-rmexpt1post-vrskybox7.js';
      const _narrative = pathPrefix + 'app/narrative.js';
      
      // Debug: Show what URLs will be resolved
      console.log('Path Resolution:');
      console.log('- Path Prefix:', pathPrefix);
      console.log('- Base URL:', document.baseURI);
      console.log('- Scene path:', _scene);
      console.log('- Scene URL will resolve to:', new URL(_scene, document.baseURI).href);
      console.log('- Narrative path:', _narrative);
      console.log('- Narrative URL will resolve to:', new URL(_narrative, document.baseURI).href);
      
      // Path testing function - uncomment to test different paths
      async function testPaths() {
        const testPaths = [
          _scene,
          _narrative,
          pathPrefix + 'app/scenes/T/post/7/sgcloudpost-rmexpt1post-vrskybox7.js', // without @
          'dist/app/narrative.js',
          './dist/app/narrative.js',
          '/dist/app/narrative.js'
        ];
        
        console.log('\n=== Testing Path Resolution ===');
        for (const path of testPaths) {
          try {
            const url = new URL(path, document.baseURI).href;
            const response = await fetch(url, { method: 'HEAD' });
            if (response.ok) {
              console.log(`✓ Found: ${path} -> ${url}`);
            } else {
              console.log(`✗ Not found (${response.status}): ${path} -> ${url}`);
            }
          } catch (e) {
            console.log(`✗ Error: ${path} - ${e.message}`);
          }
        }
        console.log('=== End Path Testing ===\n');
      }
      
      // Uncomment to run path testing
      // testPaths();
      
      // load needed fundamental application modules - these are the exports 
      // from the variable scene and bootstrap-controller (urls above)
      async function load() {
        try {
          console.log(`\nAttempting to load modules...`);
          console.log(`- Scene: ${_scene}`);
          console.log(`- Narrative: ${_narrative}`);
          
          let a = await Promise.all([
            import(_scene),
            import(_narrative)
          ]).catch((e) => {
            console.error(`Error loading modules: ${e.toString()}`);
            console.error(`Stack trace:`, e.stack);
            
            // Try alternative paths if primary paths fail
            console.log('\nTrying alternative paths...');
            const altScene = pathPrefix + 'app/scenes/T/post/7/sgcloudpost-rmexpt1post-vrskybox7.js';
            console.log(`Alternative scene path (without @): ${altScene}`);
            
            return Promise.all([
              import(altScene),
              import(_narrative)
            ]).catch((e2) => {
              console.error(`Alternative paths also failed: ${e2.toString()}`);
              throw e2;
            });
          });

          if (!a) {
            console.error('Module loading returned undefined');
            return;
          }

          console.log(`Successfully loaded ${a.length} modules`);
          
          // Diagnostic output (uncomment for debugging)
          /*
          console.log(`\nindex: a is type ${typeof(a)}`);
          console.log(`a is an Array is ${Array.isArray(a)}`);
          console.log(`dynamically loaded module-array a:`);
          console.dir(a);
          for(let p in a){
            console.log(`\na[${p}] is type ${typeof(a[p])}`);
            console.log(`module[${p}] has value:`)
            console.dir(a[p]);
          }
          */

          // Extract config and state from scene module, narrative from narrative module
          let config = a[0].config;
          let state = a[0].state;
          let narrative = a[1].narrative;
          
          if (!config || !state || !narrative) {
            console.error('Missing required exports from modules:', {
              hasConfig: !!config,
              hasState: !!state,
              hasNarrative: !!narrative
            });
            return;
          }

          // load config.imports
          console.log('Bootstrapping narrative with config and state...');
          narrative.bootstrap(config, state);
          
        } catch (error) {
          console.error('Fatal error in load():', error);
          
          // Display error in debug panel if visible
          const debugElement = document.getElementById('debug-info');
          if (debugElement) {
            debugElement.style.display = 'block';
            debugElement.innerHTML = `
              <strong>Error Loading Application:</strong><br>
              ${error.message}<br><br>
              <strong>Attempted Paths:</strong><br>
              Scene: ${_scene}<br>
              Narrative: ${_narrative}<br><br>
              Check console for more details.
            `;
          }
        }
      };

      console.log(`\n*** Dynamic-path HTML starting scene ${_scene} using controller ${_narrative}`);
      console.log(`*** Environment: ${env.isGitHubPages ? 'GitHub Pages' : env.isLocalhost ? 'Localhost' : 'Other'}`);
      console.log(`*** Base path: ${env.basePath || '(none)'}\n\n`);
      
      // Start loading
      load();
    </script>

    <!-- Fallback for browsers that don't support module-shim -->
    <script nomodule>
      document.body.innerHTML = '<h1 style="color: white; padding: 20px;">This application requires a browser with ES6 module support.</h1>';
    </script>
  </body>
</html>
